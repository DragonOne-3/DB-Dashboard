import streamlit as st
import pandas as pd
import gspread
from oauth2client.service_account import ServiceAccountCredentials
import json
import os
from datetime import datetime
from dateutil.relativedelta import relativedelta
import re

# --- 226ê°œ ê´‘ì—­+ê¸°ì´ˆ í†µí•© ë¦¬ìŠ¤íŠ¸ (ì¤‘ë³µ ì´ë¦„ êµ¬ë¶„ìš©) ---
FULL_DISTRICT_LIST = [
    "ì„œìš¸íŠ¹ë³„ì‹œ ì¢…ë¡œêµ¬", "ì„œìš¸íŠ¹ë³„ì‹œ ì¤‘êµ¬", "ì„œìš¸íŠ¹ë³„ì‹œ ìš©ì‚°êµ¬", "ì„œìš¸íŠ¹ë³„ì‹œ ì„±ë™êµ¬", "ì„œìš¸íŠ¹ë³„ì‹œ ê´‘ì§„êµ¬", "ì„œìš¸íŠ¹ë³„ì‹œ ë™ëŒ€ë¬¸êµ¬", "ì„œìš¸íŠ¹ë³„ì‹œ ì¤‘ë‘êµ¬", "ì„œìš¸íŠ¹ë³„ì‹œ ì„±ë¶êµ¬", "ì„œìš¸íŠ¹ë³„ì‹œ ê°•ë¶êµ¬", "ì„œìš¸íŠ¹ë³„ì‹œ ë„ë´‰êµ¬", "ì„œìš¸íŠ¹ë³„ì‹œ ë…¸ì›êµ¬", "ì„œìš¸íŠ¹ë³„ì‹œ ì€í‰êµ¬", "ì„œìš¸íŠ¹ë³„ì‹œ ì„œëŒ€ë¬¸êµ¬", "ì„œìš¸íŠ¹ë³„ì‹œ ë§ˆí¬êµ¬", "ì„œìš¸íŠ¹ë³„ì‹œ ì–‘ì²œêµ¬", "ì„œìš¸íŠ¹ë³„ì‹œ ê°•ì„œêµ¬", "ì„œìš¸íŠ¹ë³„ì‹œ êµ¬ë¡œêµ¬", "ì„œìš¸íŠ¹ë³„ì‹œ ê¸ˆì²œêµ¬", "ì„œìš¸íŠ¹ë³„ì‹œ ì˜ë“±í¬êµ¬", "ì„œìš¸íŠ¹ë³„ì‹œ ë™ì‘êµ¬", "ì„œìš¸íŠ¹ë³„ì‹œ ê´€ì•…êµ¬", "ì„œìš¸íŠ¹ë³„ì‹œ ì„œì´ˆêµ¬", "ì„œìš¸íŠ¹ë³„ì‹œ ê°•ë‚¨êµ¬", "ì„œìš¸íŠ¹ë³„ì‹œ ì†¡íŒŒêµ¬", "ì„œìš¸íŠ¹ë³„ì‹œ ê°•ë™êµ¬",
    "ë¶€ì‚°ê´‘ì—­ì‹œ ì¤‘êµ¬", "ë¶€ì‚°ê´‘ì—­ì‹œ ì„œêµ¬", "ë¶€ì‚°ê´‘ì—­ì‹œ ë™êµ¬", "ë¶€ì‚°ê´‘ì—­ì‹œ ì˜ë„êµ¬", "ë¶€ì‚°ê´‘ì—­ì‹œ ë¶€ì‚°ì§„êµ¬", "ë¶€ì‚°ê´‘ì—­ì‹œ ë™ë˜êµ¬", "ë¶€ì‚°ê´‘ì—­ì‹œ ë‚¨êµ¬", "ë¶€ì‚°ê´‘ì—­ì‹œ ë¶êµ¬", "ë¶€ì‚°ê´‘ì—­ì‹œ í•´ìš´ëŒ€êµ¬", "ë¶€ì‚°ê´‘ì—­ì‹œ ì‚¬í•˜êµ¬", "ë¶€ì‚°ê´‘ì—­ì‹œ ê¸ˆì •êµ¬", "ë¶€ì‚°ê´‘ì—­ì‹œ ê°•ì„œêµ¬", "ë¶€ì‚°ê´‘ì—­ì‹œ ì—°ì œêµ¬", "ë¶€ì‚°ê´‘ì—­ì‹œ ìˆ˜ì˜êµ¬", "ë¶€ì‚°ê´‘ì—­ì‹œ ì‚¬ìƒêµ¬", "ë¶€ì‚°ê´‘ì—­ì‹œ ê¸°ì¥êµ°",
    "ëŒ€êµ¬ê´‘ì—­ì‹œ ì¤‘êµ¬", "ëŒ€êµ¬ê´‘ì—­ì‹œ ë™êµ¬", "ëŒ€êµ¬ê´‘ì—­ì‹œ ì„œêµ¬", "ëŒ€êµ¬ê´‘ì—­ì‹œ ë‚¨êµ¬", "ëŒ€êµ¬ê´‘ì—­ì‹œ ë¶êµ¬", "ëŒ€êµ¬ê´‘ì—­ì‹œ ìˆ˜ì„±êµ¬", "ëŒ€êµ¬ê´‘ì—­ì‹œ ë‹¬ì„œêµ¬", "ëŒ€êµ¬ê´‘ì—­ì‹œ ë‹¬ì„±êµ°", "ëŒ€êµ¬ê´‘ì—­ì‹œ êµ°ìœ„êµ°",
    "ì¸ì²œê´‘ì—­ì‹œ ì¤‘êµ¬", "ì¸ì²œê´‘ì—­ì‹œ ë™êµ¬", "ì¸ì²œê´‘ì—­ì‹œ ë¯¸ì¶”í™€êµ¬", "ì¸ì²œê´‘ì—­ì‹œ ì—°ìˆ˜êµ¬", "ì¸ì²œê´‘ì—­ì‹œ ë‚¨ë™êµ¬", "ì¸ì²œê´‘ì—­ì‹œ ë¶€í‰êµ¬", "ì¸ì²œê´‘ì—­ì‹œ ê³„ì–‘êµ¬", "ì¸ì²œê´‘ì—­ì‹œ ì„œêµ¬", "ì¸ì²œê´‘ì—­ì‹œ ê°•í™”êµ°", "ì¸ì²œê´‘ì—­ì‹œ ì˜¹ì§„êµ°",
    "ê´‘ì£¼ê´‘ì—­ì‹œ ë™êµ¬", "ê´‘ì£¼ê´‘ì—­ì‹œ ì„œêµ¬", "ê´‘ì£¼ê´‘ì—­ì‹œ ë‚¨êµ¬", "ê´‘ì£¼ê´‘ì—­ì‹œ ë¶êµ¬", "ê´‘ì£¼ê´‘ì—­ì‹œ ê´‘ì‚°êµ¬",
    "ëŒ€ì „ê´‘ì—­ì‹œ ë™êµ¬", "ëŒ€ì „ê´‘ì—­ì‹œ ì¤‘êµ¬", "ëŒ€ì „ê´‘ì—­ì‹œ ì„œêµ¬", "ëŒ€ì „ê´‘ì—­ì‹œ ìœ ì„±êµ¬", "ëŒ€ì „ê´‘ì—­ì‹œ ëŒ€ë•êµ¬",
    "ìš¸ì‚°ê´‘ì—­ì‹œ ì¤‘êµ¬", "ìš¸ì‚°ê´‘ì—­ì‹œ ë‚¨êµ¬", "ìš¸ì‚°ê´‘ì—­ì‹œ ë™êµ¬", "ìš¸ì‚°ê´‘ì—­ì‹œ ë¶êµ¬", "ìš¸ì‚°ê´‘ì—­ì‹œ ìš¸ì£¼êµ°",
    "ì„¸ì¢…íŠ¹ë³„ìì¹˜ì‹œ",
    "ê²½ê¸°ë„ ìˆ˜ì›ì‹œ", "ê²½ê¸°ë„ ì„±ë‚¨ì‹œ", "ê²½ê¸°ë„ ì˜ì •ë¶€ì‹œ", "ê²½ê¸°ë„ ì•ˆì–‘ì‹œ", "ê²½ê¸°ë„ ë¶€ì²œì‹œ", "ê²½ê¸°ë„ ê´‘ëª…ì‹œ", "ê²½ê¸°ë„ í‰íƒì‹œ", "ê²½ê¸°ë„ ë™ë‘ì²œì‹œ", "ê²½ê¸°ë„ ì•ˆì‚°ì‹œ", "ê²½ê¸°ë„ ê³ ì–‘ì‹œ", "ê²½ê¸°ë„ ê³¼ì²œì‹œ", "ê²½ê¸°ë„ êµ¬ë¦¬ì‹œ", "ê²½ê¸°ë„ ë‚¨ì–‘ì£¼ì‹œ", "ê²½ê¸°ë„ ì˜¤ì‚°ì‹œ", "ê²½ê¸°ë„ ì‹œí¥ì‹œ", "ê²½ê¸°ë„ êµ°í¬ì‹œ", "ê²½ê¸°ë„ ì˜ì™•ì‹œ", "ê²½ê¸°ë„ í•˜ë‚¨ì‹œ", "ê²½ê¸°ë„ ìš©ì¸ì‹œ", "ê²½ê¸°ë„ íŒŒì£¼ì‹œ", "ê²½ê¸°ë„ ì´ì²œì‹œ", "ê²½ê¸°ë„ ì•ˆì„±ì‹œ", "ê²½ê¸°ë„ ê¹€í¬ì‹œ", "ê²½ê¸°ë„ í™”ì„±ì‹œ", "ê²½ê¸°ë„ ê´‘ì£¼ì‹œ", "ê²½ê¸°ë„ ì–‘ì£¼ì‹œ", "ê²½ê¸°ë„ í¬ì²œì‹œ", "ê²½ê¸°ë„ ì—¬ì£¼ì‹œ", "ê²½ê¸°ë„ ì—°ì²œêµ°", "ê²½ê¸°ë„ ê°€í‰êµ°", "ê²½ê¸°ë„ ì–‘í‰êµ°",
    "ê°•ì›íŠ¹ë³„ìì¹˜ë„ ì¶˜ì²œì‹œ", "ê°•ì›íŠ¹ë³„ìì¹˜ë„ ì›ì£¼ì‹œ", "ê°•ì›íŠ¹ë³„ìì¹˜ë„ ê°•ë¦‰ì‹œ", "ê°•ì›íŠ¹ë³„ìì¹˜ë„ ë™í•´ì‹œ", "ê°•ì›íŠ¹ë³„ìì¹˜ë„ íƒœë°±ì‹œ", "ê°•ì›íŠ¹ë³„ìì¹˜ë„ ì†ì´ˆì‹œ", "ê°•ì›íŠ¹ë³„ìì¹˜ë„ ì‚¼ì²™ì‹œ", "ê°•ì›íŠ¹ë³„ìì¹˜ë„ í™ì²œêµ°", "ê°•ì›íŠ¹ë³„ìì¹˜ë„ íš¡ì„±êµ°", "ê°•ì›íŠ¹ë³„ìì¹˜ë„ ì˜ì›”êµ°", "ê°•ì›íŠ¹ë³„ìì¹˜ë„ í‰ì°½êµ°", "ê°•ì›íŠ¹ë³„ìì¹˜ë„ ì •ì„ êµ°", "ê°•ì›íŠ¹ë³„ìì¹˜ë„ ì² ì›êµ°", "ê°•ì›íŠ¹ë³„ìì¹˜ë„ í™”ì²œêµ°", "ê°•ì›íŠ¹ë³„ìì¹˜ë„ ì–‘êµ¬êµ°", "ê°•ì›íŠ¹ë³„ìì¹˜ë„ ì¸ì œêµ°", "ê°•ì›íŠ¹ë³„ìì¹˜ë„ ê³ ì„±êµ°", "ê°•ì›íŠ¹ë³„ìì¹˜ë„ ì–‘ì–‘êµ°",
    "ì¶©ì²­ë¶ë„ ì²­ì£¼ì‹œ", "ì¶©ì²­ë¶ë„ ì¶©ì£¼ì‹œ", "ì¶©ì²­ë¶ë„ ì œì²œì‹œ", "ì¶©ì²­ë¶ë„ ë³´ì€êµ°", "ì¶©ì²­ë¶ë„ ì˜¥ì²œêµ°", "ì¶©ì²­ë¶ë„ ì˜ë™êµ°", "ì¶©ì²­ë¶ë„ ì¦í‰êµ°", "ì¶©ì²­ë¶ë„ ì§„ì²œêµ°", "ì¶©ì²­ë¶ë„ ê´´ì‚°êµ°", "ì¶©ì²­ë¶ë„ ìŒì„±êµ°", "ì¶©ì²­ë¶ë„ ë‹¨ì–‘êµ°",
    "ì¶©ì²­ë‚¨ë„ ì²œì•ˆì‹œ", "ì¶©ì²­ë‚¨ë„ ê³µì£¼ì‹œ", "ì¶©ì²­ë‚¨ë„ ë³´ë ¹ì‹œ", "ì¶©ì²­ë‚¨ë„ ì•„ì‚°ì‹œ", "ì¶©ì²­ë‚¨ë„ ì„œì‚°ì‹œ", "ì¶©ì²­ë‚¨ë„ ë…¼ì‚°ì‹œ", "ì¶©ì²­ë‚¨ë„ ê³„ë£¡ì‹œ", "ì¶©ì²­ë‚¨ë„ ë‹¹ì§„ì‹œ", "ì¶©ì²­ë‚¨ë„ ê¸ˆì‚°êµ°", "ì¶©ì²­ë‚¨ë„ ë¶€ì—¬êµ°", "ì¶©ì²­ë‚¨ë„ ì„œì²œêµ°", "ì¶©ì²­ë‚¨ë„ ì²­ì–‘êµ°", "ì¶©ì²­ë‚¨ë„ í™ì„±êµ°", "ì¶©ì²­ë‚¨ë„ ì˜ˆì‚°êµ°", "ì¶©ì²­ë‚¨ë„ íƒœì•ˆêµ°",
    "ì „ë¶íŠ¹ë³„ìì¹˜ë„ ì „ì£¼ì‹œ", "ì „ë¶íŠ¹ë³„ìì¹˜ë„ êµ°ì‚°ì‹œ", "ì „ë¶íŠ¹ë³„ìì¹˜ë„ ìµì‚°ì‹œ", "ì „ë¶íŠ¹ë³„ìì¹˜ë„ ì •ìì‹œ", "ì „ë¶íŠ¹ë³„ìì¹˜ë„ ë‚¨ì›ì‹œ", "ì „ë¶íŠ¹ë³„ìì¹˜ë„ ê¹€ì œì‹œ", "ì „ë¶íŠ¹ë³„ìì¹˜ë„ ì™„ì£¼êµ°", "ì „ë¶íŠ¹ë³„ìì¹˜ë„ ì§„ì•ˆêµ°", "ì „ë¶íŠ¹ë³„ìì¹˜ë„ ë¬´ì£¼êµ°", "ì „ë¶íŠ¹ë³„ìì¹˜ë„ ì¥ìˆ˜êµ°", "ì „ë¶íŠ¹ë³„ìì¹˜ë„ ì„ì‹¤êµ°", "ì „ë¶íŠ¹ë³„ìì¹˜ë„ ìˆœì°½êµ°", "ì „ë¶íŠ¹ë³„ìì¹˜ë„ ê³ ì°½êµ°", "ì „ë¶íŠ¹ë³„ìì¹˜ë„ ë¶€ì•ˆêµ°",
    "ì „ë¼ë‚¨ë„ ëª©í¬ì‹œ", "ì „ë¼ë‚¨ë„ ì—¬ìˆ˜ì‹œ", "ì „ë¼ë‚¨ë„ ìˆœì²œì‹œ", "ì „ë¼ë‚¨ë„ ë‚˜ì£¼ì‹œ", "ì „ë¼ë‚¨ë„ ê´‘ì–‘ì‹œ", "ì „ë¼ë‚¨ë„ ë‹´ì–‘êµ°", "ì „ë¼ë‚¨ë„ ê³¡ì„±êµ°", "ì „ë¼ë‚¨ë„ êµ¬ë¡€êµ°", "ì „ë¼ë‚¨ë„ ê³ í¥êµ°", "ì „ë¼ë‚¨ë„ ë³´ì„±êµ°", "ì „ë¼ë‚¨ë„ í™”ìˆœêµ°", "ì „ë¼ë‚¨ë„ ì¥í¥êµ°", "ì „ë¼ë‚¨ë„ ê°•ì§„êµ°", "ì „ë¼ë‚¨ë„ í•´ë‚¨êµ°", "ì „ë¼ë‚¨ë„ ì˜ì•”êµ°", "ì „ë¼ë‚¨ë„ ë¬´ì•ˆêµ°", "ì „ë¼ë‚¨ë„ í•¨í‰êµ°", "ì „ë¼ë‚¨ë„ ì˜ê´‘êµ°", "ì „ë¼ë‚¨ë„ ì¥ì„±êµ°", "ì „ë¼ë‚¨ë„ ì™„ë„êµ°", "ì „ë¼ë‚¨ë„ ì§„ë„êµ°", "ì „ë¼ë‚¨ë„ ì‹ ì•ˆêµ°",
    "ê²½ìƒë¶ë„ í¬í•­ì‹œ", "ê²½ìƒë¶ë„ ê²½ì£¼ì‹œ", "ê²½ìƒë¶ë„ ê¹€ì²œì‹œ", "ê²½ìƒë¶ë„ ì•ˆë™ì‹œ", "ê²½ìƒë¶ë„ êµ¬ë¯¸ì‹œ", "ê²½ìƒë¶ë„ ì˜ì£¼ì‹œ", "ê²½ìƒë¶ë„ ìƒì£¼ì‹œ", "ê²½ìƒë¶ë„ ë¬¸ê²½ì‹œ", "ê²½ìƒë¶ë„ ê²½ì‚°ì‹œ", "ê²½ìƒë¶ë„ ì˜ì„±êµ°", "ê²½ìƒë¶ë„ ì²­ì†¡êµ°", "ê²½ìƒë¶ë„ ì˜ì–‘êµ°", "ê²½ìƒë¶ë„ ì˜ë•êµ°", "ê²½ìƒë¶ë„ ì²­ë„êµ°", "ê²½ìƒë¶ë„ ê³ ë ¹êµ°", "ê²½ìƒë¶ë„ ì„±ì£¼êµ°", "ê²½ìƒë¶ë„ ì¹ ê³¡êµ°", "ê²½ìƒë¶ë„ ì˜ˆì²œêµ°", "ê²½ìƒë¶ë„ ë´‰í™”êµ°", "ê²½ìƒë¶ë„ ìš¸ì§„êµ°", "ê²½ìƒë¶ë„ ìš¸ë¦‰êµ°",
    "ê²½ìƒë‚¨ë„ ì°½ì›ì‹œ", "ê²½ìƒë‚¨ë„ ì§„ì£¼ì‹œ", "ê²½ìƒë‚¨ë„ í†µì˜ì‹œ", "ê²½ìƒë‚¨ë„ ì‚¬ì²œì‹œ", "ê²½ìƒë‚¨ë„ ê¹€í•´ì‹œ", "ê²½ìƒë‚¨ë„ ë°€ì–‘ì‹œ", "ê²½ìƒë‚¨ë„ ê±°ì œì‹œ", "ê²½ìƒë‚¨ë„ ì–‘ì‚°ì‹œ", "ê²½ìƒë‚¨ë„ ì˜ë ¹êµ°", "ê²½ìƒë‚¨ë„ í•¨ì•ˆêµ°", "ê²½ìƒë‚¨ë„ ì°½ë…•êµ°", "ê²½ìƒë‚¨ë„ ê³ ì„±êµ°", "ê²½ìƒë‚¨ë„ ë‚¨í•´êµ°", "ê²½ìƒë‚¨ë„ í•˜ë™êµ°", "ê²½ìƒë‚¨ë„ ì‚°ì²­êµ°", "ê²½ìƒë‚¨ë„ í•¨ì–‘êµ°", "ê²½ìƒë‚¨ë„ ê±°ì°½êµ°", "ê²½ìƒë‚¨ë„ í•©ì²œêµ°",
    "ì œì£¼íŠ¹ë³„ìì¹˜ë„ ì œì£¼ì‹œ", "ì œì£¼íŠ¹ë³„ìì¹˜ë„ ì„œê·€í¬ì‹œ"
]
def get_data_from_gsheet():
    auth_json = os.environ.get('GOOGLE_AUTH_JSON')
    
    if auth_json is None:
        st.error("âŒ 'GOOGLE_AUTH_JSON' í™˜ê²½ ë³€ìˆ˜ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ë¡œì»¬ í…ŒìŠ¤íŠ¸ ì‹œì—ëŠ” JSON íŒŒì¼ì„ ì§ì ‘ ì°¸ì¡°í•˜ë„ë¡ ì½”ë“œë¥¼ ìˆ˜ì •í•˜ê±°ë‚˜ í™˜ê²½ ë³€ìˆ˜ë¥¼ ë“±ë¡í•˜ì„¸ìš”.")
        return pd.DataFrame()

    try:
        creds_dict = json.loads(auth_json)
        scope = ["https://spreadsheets.google.com/feeds", "https://www.googleapis.com/auth/drive"]
        creds = ServiceAccountCredentials.from_json_keyfile_dict(creds_dict, scope)
        client = gspread.authorize(creds)
        sh = client.open("ë‚˜ë¼ì¥í„°_ìš©ì—­ê³„ì•½ë‚´ì—­")
        ws = sh.get_worksheet(0)
        return pd.DataFrame(ws.get_all_records())
    except Exception as e:
        st.error(f"âŒ ì‹œíŠ¸ ë¡œë“œ ì¤‘ ì˜¤ë¥˜: {e}")
        return pd.DataFrame()
def calculate_dates(row):
    try:
        # ë‚ ì§œ ë° ê¸°ê°„ ë°ì´í„° ì¶”ì¶œ
        c_date_raw = str(row.get('cntrctDate', ''))[:8]
        s_date_raw = str(row.get('wbgnDate', ''))[:8]
        prd = str(row.get('cntrctPrd', ''))
        
        c_date = pd.to_datetime(c_date_raw, errors='coerce')
        s_date = pd.to_datetime(s_date_raw, errors='coerce')

        expire_date = None
        # 1. ë§Œë£Œì¼(prd)ì´ ì´ë¯¸ ë‚ ì§œ(8ìë¦¬ ìˆ«ì)ì¸ ê²½ìš°
        if len(prd) >= 8 and prd.isdigit():
            expire_date = pd.to_datetime(prd[:8], errors='coerce')
        # 2. ë§Œë£Œì¼ì´ ì¼ìˆ˜(Nì¼) í˜•íƒœì¸ ê²½ìš° ê³„ì‚°
        elif prd:
            days_val = int(re.sub(r'[^0-9]', '', prd))
            thtm = row.get('thtmCntrctAmt', 0)
            ttal = row.get('totCntrctAmt', 0)
            # ì¡°ê±´: ê¸ˆì°¨ì™€ ì´ì°¨ê°€ ê°™ìœ¼ë©´ ê³„ì•½ì¼ ê¸°ì¤€, ë‹¤ë¥´ë©´ ì°©ìˆ˜ì¼ ê¸°ì¤€
            base_date = c_date if thtm == ttal else s_date
            if pd.notnull(base_date):
                expire_date = base_date + pd.Timedelta(days=days_val)
        
        if pd.isnull(expire_date): return None, "ì •ë³´ì—†ìŒ"

        # 3. ë‚¨ì€ ê¸°ê°„ ê³„ì‚°
        today = datetime.now()
        diff = relativedelta(expire_date, today)
        if expire_date < today: return expire_date.strftime('%Y-%m-%d'), "ë§Œë£Œë¨"
        
        return expire_date.strftime('%Y-%m-%d'), f"{diff.years*12 + diff.months}ê°œì›” {diff.days}ì¼"
    except: return None, "ê³„ì‚°ë¶ˆê°€"

# --- ìŠ¤íŠ¸ë¦¼ë¦¿ ë©”ì¸ ---
st.set_page_config(layout="wide", page_title="ì§€ìì²´ ìš©ì—­í˜„í™©")
st.title("ğŸ›ï¸ ì „êµ­ ê¸°ì´ˆìì¹˜ë‹¨ì²´ ìš©ì—­ ê³„ì•½ ëª¨ë‹ˆí„°ë§")

try:
    # ë°ì´í„° ë¡œë“œ
    auth_json = os.environ.get('GOOGLE_AUTH_JSON')
    creds = ServiceAccountCredentials.from_json_keyfile_dict(json.loads(auth_json), ["https://spreadsheets.google.com/feeds", "https://www.googleapis.com/auth/drive"])
    ws = gspread.authorize(creds).open("ë‚˜ë¼ì¥í„°_ìš©ì—­ê³„ì•½ë‚´ì—­").get_worksheet(0)
    df = pd.DataFrame(ws.get_all_records())

    # 1. í•„í„°ë§: ê´‘ì—­+ê¸°ì´ˆ ëª…ì¹­ì´ í¬í•¨ëœ ì§€ìì²´ë§Œ
    df = df[df['â˜…ê°€ê³µ_ìˆ˜ìš”ê¸°ê´€'].apply(lambda x: any(d in x for d in FULL_DISTRICT_LIST))]

    # 2. ë‚ ì§œ ë° ì”ì—¬ ê¸°ê°„ ê³„ì‚°
    df[['ê³„ì•½ë§Œë£Œì¼', 'ë‚¨ì€ê¸°ê°„']] = df.apply(lambda r: pd.Series(calculate_dates(r)), axis=1)

    # 3. ê¸°ê´€ë³„ ê°€ì¥ ìµœê·¼ ê³„ì•½ê±´(cntrctDate ê¸°ì¤€)ë§Œ ìœ ì§€
    df['cntrctDate_dt'] = pd.to_datetime(df['cntrctDate'].astype(str).str[:8], errors='coerce')
    df = df.sort_values(by=['â˜…ê°€ê³µ_ìˆ˜ìš”ê¸°ê´€', 'cntrctDate_dt'], ascending=[True, False])
    df = df.drop_duplicates(subset=['â˜…ê°€ê³µ_ìˆ˜ìš”ê¸°ê´€'], keep='first')

    # 4. í‘œì¶œ ë°ì´í„° êµ¬ì„±
    display_df = df[[
        'â˜…ê°€ê³µ_ìˆ˜ìš”ê¸°ê´€', 'â˜…ê°€ê³µ_ê³„ì•½ëª…', 'â˜…ê°€ê³µ_ì—…ì²´ëª…', 'â˜…ê°€ê³µ_ê³„ì•½ê¸ˆì•¡',
        'â˜…ê°€ê³µ_ê³„ì•½ì¼', 'â˜…ê°€ê³µ_ì°©ìˆ˜ì¼', 'ê³„ì•½ë§Œë£Œì¼', 'ë‚¨ì€ê¸°ê°„', 'cntrctDtlInfoUrl'
    ]].copy()
    display_df.columns = ['ìˆ˜ìš”ê¸°ê´€', 'ê³„ì•½ëª…', 'ì—…ì²´ëª…', 'ê³„ì•½ê¸ˆì•¡(ì›)', 'ê³„ì•½ì¼ì', 'ì°©ìˆ˜ì¼ì', 'ê³„ì•½ë§Œë£Œì¼', 'ë‚¨ì€ê¸°ê°„', 'ìƒì„¸URL']

    # 5. í‘œì¶œ (ìˆ˜ìš”ê¸°ê´€ ê¸°ì¤€ ì •ë ¬ ë° ì •ë ¬ ê¸°ëŠ¥ ì§€ì›)
    st.dataframe(
        display_df,
        column_config={"ìƒì„¸URL": st.column_config.LinkColumn("ë§í¬")},
        use_container_width=True, hide_index=True
    )

except Exception as e:
    st.error(f"ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜: {e}")
