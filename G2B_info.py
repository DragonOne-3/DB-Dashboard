import streamlit as st
import pandas as pd
import gspread
from oauth2client.service_account import ServiceAccountCredentials
import json
import os
from datetime import datetime
from dateutil.relativedelta import relativedelta
import re
import io

# --- 1. 226ê°œ ê´‘ì—­+ê¸°ì´ˆ í†µí•© ë¦¬ìŠ¤íŠ¸ ---
FULL_DISTRICT_LIST = [
    "ì„œìš¸íŠ¹ë³„ì‹œ", "ì„œìš¸íŠ¹ë³„ì‹œ ì¢…ë¡œêµ¬", "ì„œìš¸íŠ¹ë³„ì‹œ ì¤‘êµ¬", "ì„œìš¸íŠ¹ë³„ì‹œ ìš©ì‚°êµ¬", "ì„œìš¸íŠ¹ë³„ì‹œ ì„±ë™êµ¬", "ì„œìš¸íŠ¹ë³„ì‹œ ê´‘ì§„êµ¬", "ì„œìš¸íŠ¹ë³„ì‹œ ë™ëŒ€ë¬¸êµ¬", "ì„œìš¸íŠ¹ë³„ì‹œ ì¤‘ëž‘êµ¬", "ì„œìš¸íŠ¹ë³„ì‹œ ì„±ë¶êµ¬", "ì„œìš¸íŠ¹ë³„ì‹œ ê°•ë¶êµ¬", "ì„œìš¸íŠ¹ë³„ì‹œ ë„ë´‰êµ¬", "ì„œìš¸íŠ¹ë³„ì‹œ ë…¸ì›êµ¬", "ì„œìš¸íŠ¹ë³„ì‹œ ì€í‰êµ¬", "ì„œìš¸íŠ¹ë³„ì‹œ ì„œëŒ€ë¬¸êµ¬", "ì„œìš¸íŠ¹ë³„ì‹œ ë§ˆí¬êµ¬", "ì„œìš¸íŠ¹ë³„ì‹œ ì–‘ì²œêµ¬", "ì„œìš¸íŠ¹ë³„ì‹œ ê°•ì„œêµ¬", "ì„œìš¸íŠ¹ë³„ì‹œ êµ¬ë¡œêµ¬", "ì„œìš¸íŠ¹ë³„ì‹œ ê¸ˆì²œêµ¬", "ì„œìš¸íŠ¹ë³„ì‹œ ì˜ë“±í¬êµ¬", "ì„œìš¸íŠ¹ë³„ì‹œ ë™ìž‘êµ¬", "ì„œìš¸íŠ¹ë³„ì‹œ ê´€ì•…êµ¬", "ì„œìš¸íŠ¹ë³„ì‹œ ì„œì´ˆêµ¬", "ì„œìš¸íŠ¹ë³„ì‹œ ê°•ë‚¨êµ¬", "ì„œìš¸íŠ¹ë³„ì‹œ ì†¡íŒŒêµ¬", "ì„œìš¸íŠ¹ë³„ì‹œ ê°•ë™êµ¬",
    "ë¶€ì‚°ê´‘ì—­ì‹œ", "ë¶€ì‚°ê´‘ì—­ì‹œ ì¤‘êµ¬", "ë¶€ì‚°ê´‘ì—­ì‹œ ì„œêµ¬", "ë¶€ì‚°ê´‘ì—­ì‹œ ë™êµ¬", "ë¶€ì‚°ê´‘ì—­ì‹œ ì˜ë„êµ¬", "ë¶€ì‚°ê´‘ì—­ì‹œ ë¶€ì‚°ì§„êµ¬", "ë¶€ì‚°ê´‘ì—­ì‹œ ë™ëž˜êµ¬", "ë¶€ì‚°ê´‘ì—­ì‹œ ë‚¨êµ¬", "ë¶€ì‚°ê´‘ì—­ì‹œ ë¶êµ¬", "ë¶€ì‚°ê´‘ì—­ì‹œ í•´ìš´ëŒ€êµ¬", "ë¶€ì‚°ê´‘ì—­ì‹œ ì‚¬í•˜êµ¬", "ë¶€ì‚°ê´‘ì—­ì‹œ ê¸ˆì •êµ¬", "ë¶€ì‚°ê´‘ì—­ì‹œ ê°•ì„œêµ¬", "ë¶€ì‚°ê´‘ì—­ì‹œ ì—°ì œêµ¬", "ë¶€ì‚°ê´‘ì—­ì‹œ ìˆ˜ì˜êµ¬", "ë¶€ì‚°ê´‘ì—­ì‹œ ì‚¬ìƒêµ¬", "ë¶€ì‚°ê´‘ì—­ì‹œ ê¸°ìž¥êµ°",
    "ëŒ€êµ¬ê´‘ì—­ì‹œ", "ëŒ€êµ¬ê´‘ì—­ì‹œ ì¤‘êµ¬", "ëŒ€êµ¬ê´‘ì—­ì‹œ ë™êµ¬", "ëŒ€êµ¬ê´‘ì—­ì‹œ ì„œêµ¬", "ëŒ€êµ¬ê´‘ì—­ì‹œ ë‚¨êµ¬", "ëŒ€êµ¬ê´‘ì—­ì‹œ ë¶êµ¬", "ëŒ€êµ¬ê´‘ì—­ì‹œ ìˆ˜ì„±êµ¬", "ëŒ€êµ¬ê´‘ì—­ì‹œ ë‹¬ì„œêµ¬", "ëŒ€êµ¬ê´‘ì—­ì‹œ ë‹¬ì„±êµ°", "ëŒ€êµ¬ê´‘ì—­ì‹œ êµ°ìœ„êµ°",
    "ì¸ì²œê´‘ì—­ì‹œ", "ì¸ì²œê´‘ì—­ì‹œ ì¤‘êµ¬", "ì¸ì²œê´‘ì—­ì‹œ ë™êµ¬", "ì¸ì²œê´‘ì—­ì‹œ ë¯¸ì¶”í™€êµ¬", "ì¸ì²œê´‘ì—­ì‹œ ì—°ìˆ˜êµ¬", "ì¸ì²œê´‘ì—­ì‹œ ë‚¨ë™êµ¬", "ì¸ì²œê´‘ì—­ì‹œ ë¶€í‰êµ¬", "ì¸ì²œê´‘ì—­ì‹œ ê³„ì–‘êµ¬", "ì¸ì²œê´‘ì—­ì‹œ ì„œêµ¬", "ì¸ì²œê´‘ì—­ì‹œ ê°•í™”êµ°", "ì¸ì²œê´‘ì—­ì‹œ ì˜¹ì§„êµ°",
    "ê´‘ì£¼ê´‘ì—­ì‹œ", "ê´‘ì£¼ê´‘ì—­ì‹œ ë™êµ¬", "ê´‘ì£¼ê´‘ì—­ì‹œ ì„œêµ¬", "ê´‘ì£¼ê´‘ì—­ì‹œ ë‚¨êµ¬", "ê´‘ì£¼ê´‘ì—­ì‹œ ë¶êµ¬", "ê´‘ì£¼ê´‘ì—­ì‹œ ê´‘ì‚°êµ¬",
    "ëŒ€ì „ê´‘ì—­ì‹œ", "ëŒ€ì „ê´‘ì—­ì‹œ ë™êµ¬", "ëŒ€ì „ê´‘ì—­ì‹œ ì¤‘êµ¬", "ëŒ€ì „ê´‘ì—­ì‹œ ì„œêµ¬", "ëŒ€ì „ê´‘ì—­ì‹œ ìœ ì„±êµ¬", "ëŒ€ì „ê´‘ì—­ì‹œ ëŒ€ë•êµ¬",
    "ìš¸ì‚°ê´‘ì—­ì‹œ", "ìš¸ì‚°ê´‘ì—­ì‹œ ì¤‘êµ¬", "ìš¸ì‚°ê´‘ì—­ì‹œ ë‚¨êµ¬", "ìš¸ì‚°ê´‘ì—­ì‹œ ë™êµ¬", "ìš¸ì‚°ê´‘ì—­ì‹œ ë¶êµ¬", "ìš¸ì‚°ê´‘ì—­ì‹œ ìš¸ì£¼êµ°",
    "ì„¸ì¢…íŠ¹ë³„ìžì¹˜ì‹œ",
    "ê²½ê¸°ë„ ìˆ˜ì›ì‹œ", "ê²½ê¸°ë„ ì„±ë‚¨ì‹œ", "ê²½ê¸°ë„ ì˜ì •ë¶€ì‹œ", "ê²½ê¸°ë„ ì•ˆì–‘ì‹œ", "ê²½ê¸°ë„ ë¶€ì²œì‹œ", "ê²½ê¸°ë„ ê´‘ëª…ì‹œ", "ê²½ê¸°ë„ í‰íƒì‹œ", "ê²½ê¸°ë„ ë™ë‘ì²œì‹œ", "ê²½ê¸°ë„ ì•ˆì‚°ì‹œ", "ê²½ê¸°ë„ ê³ ì–‘ì‹œ", "ê²½ê¸°ë„ ê³¼ì²œì‹œ", "ê²½ê¸°ë„ êµ¬ë¦¬ì‹œ", "ê²½ê¸°ë„ ë‚¨ì–‘ì£¼ì‹œ", "ê²½ê¸°ë„ ì˜¤ì‚°ì‹œ", "ê²½ê¸°ë„ ì‹œí¥ì‹œ", "ê²½ê¸°ë„ êµ°í¬ì‹œ", "ê²½ê¸°ë„ ì˜ì™•ì‹œ", "ê²½ê¸°ë„ í•˜ë‚¨ì‹œ", "ê²½ê¸°ë„ ìš©ì¸ì‹œ", "ê²½ê¸°ë„ íŒŒì£¼ì‹œ", "ê²½ê¸°ë„ ì´ì²œì‹œ", "ê²½ê¸°ë„ ì•ˆì„±ì‹œ", "ê²½ê¸°ë„ ê¹€í¬ì‹œ", "ê²½ê¸°ë„ í™”ì„±ì‹œ", "ê²½ê¸°ë„ ê´‘ì£¼ì‹œ", "ê²½ê¸°ë„ ì–‘ì£¼ì‹œ", "ê²½ê¸°ë„ í¬ì²œì‹œ", "ê²½ê¸°ë„ ì—¬ì£¼ì‹œ", "ê²½ê¸°ë„ ì—°ì²œêµ°", "ê²½ê¸°ë„ ê°€í‰êµ°", "ê²½ê¸°ë„ ì–‘í‰êµ°",
    "ê°•ì›íŠ¹ë³„ìžì¹˜ë„ ì¶˜ì²œì‹œ", "ê°•ì›íŠ¹ë³„ìžì¹˜ë„ ì›ì£¼ì‹œ", "ê°•ì›íŠ¹ë³„ìžì¹˜ë„ ê°•ë¦‰ì‹œ", "ê°•ì›íŠ¹ë³„ìžì¹˜ë„ ë™í•´ì‹œ", "ê°•ì›íŠ¹ë³„ìžì¹˜ë„ íƒœë°±ì‹œ", "ê°•ì›íŠ¹ë³„ìžì¹˜ë„ ì†ì´ˆì‹œ", "ê°•ì›íŠ¹ë³„ìžì¹˜ë„ ì‚¼ì²™ì‹œ", "ê°•ì›íŠ¹ë³„ìžì¹˜ë„ í™ì²œêµ°", "ê°•ì›íŠ¹ë³„ìžì¹˜ë„ íš¡ì„±êµ°", "ê°•ì›íŠ¹ë³„ìžì¹˜ë„ ì˜ì›”êµ°", "ê°•ì›íŠ¹ë³„ìžì¹˜ë„ í‰ì°½êµ°", "ê°•ì›íŠ¹ë³„ìžì¹˜ë„ ì •ì„ êµ°", "ê°•ì›íŠ¹ë³„ìžì¹˜ë„ ì² ì›êµ°", "ê°•ì›íŠ¹ë³„ìžì¹˜ë„ í™”ì²œêµ°", "ê°•ì›íŠ¹ë³„ìžì¹˜ë„ ì–‘êµ¬êµ°", "ê°•ì›íŠ¹ë³„ìžì¹˜ë„ ì¸ì œêµ°", "ê°•ì›íŠ¹ë³„ìžì¹˜ë„ ê³ ì„±êµ°", "ê°•ì›íŠ¹ë³„ìžì¹˜ë„ ì–‘ì–‘êµ°","ê°•ì›íŠ¹ë³„ìžì¹˜ë„ ì›ì£¼ì‹œ ë„ì‹œì •ë³´ì„¼í„°",
    "ì¶©ì²­ë¶ë„ ì²­ì£¼ì‹œ", "ì¶©ì²­ë¶ë„ ì¶©ì£¼ì‹œ", "ì¶©ì²­ë¶ë„ ì œì²œì‹œ", "ì¶©ì²­ë¶ë„ ë³´ì€êµ°", "ì¶©ì²­ë¶ë„ ì˜¥ì²œêµ°", "ì¶©ì²­ë¶ë„ ì˜ë™êµ°", "ì¶©ì²­ë¶ë„ ì¦í‰êµ°", "ì¶©ì²­ë¶ë„ ì§„ì²œêµ°", "ì¶©ì²­ë¶ë„ ê´´ì‚°êµ°", "ì¶©ì²­ë¶ë„ ìŒì„±êµ°", "ì¶©ì²­ë¶ë„ ë‹¨ì–‘êµ°",
    "ì¶©ì²­ë‚¨ë„ ì²œì•ˆì‹œ", "ì¶©ì²­ë‚¨ë„ ê³µì£¼ì‹œ", "ì¶©ì²­ë‚¨ë„ ë³´ë ¹ì‹œ", "ì¶©ì²­ë‚¨ë„ ì•„ì‚°ì‹œ", "ì¶©ì²­ë‚¨ë„ ì„œì‚°ì‹œ", "ì¶©ì²­ë‚¨ë„ ë…¼ì‚°ì‹œ", "ì¶©ì²­ë‚¨ë„ ê³„ë£¡ì‹œ", "ì¶©ì²­ë‚¨ë„ ë‹¹ì§„ì‹œ", "ì¶©ì²­ë‚¨ë„ ê¸ˆì‚°êµ°", "ì¶©ì²­ë‚¨ë„ ë¶€ì—¬êµ°", "ì¶©ì²­ë‚¨ë„ ì„œì²œêµ°", "ì¶©ì²­ë‚¨ë„ ì²­ì–‘êµ°", "ì¶©ì²­ë‚¨ë„ í™ì„±êµ°", "ì¶©ì²­ë‚¨ë„ ì˜ˆì‚°êµ°", "ì¶©ì²­ë‚¨ë„ íƒœì•ˆêµ°",
    "ì „ë¶íŠ¹ë³„ìžì¹˜ë„ ì „ì£¼ì‹œ", "ì „ë¶íŠ¹ë³„ìžì¹˜ë„ êµ°ì‚°ì‹œ", "ì „ë¶íŠ¹ë³„ìžì¹˜ë„ ìµì‚°ì‹œ", "ì „ë¶íŠ¹ë³„ìžì¹˜ë„ ì •ìì‹œ", "ì „ë¶íŠ¹ë³„ìžì¹˜ë„ ë‚¨ì›ì‹œ", "ì „ë¶íŠ¹ë³„ìžì¹˜ë„ ê¹€ì œì‹œ", "ì „ë¶íŠ¹ë³„ìžì¹˜ë„ ì™„ì£¼êµ°", "ì „ë¶íŠ¹ë³„ìžì¹˜ë„ ì§„ì•ˆêµ°", "ì „ë¶íŠ¹ë³„ìžì¹˜ë„ ë¬´ì£¼êµ°", "ì „ë¶íŠ¹ë³„ìžì¹˜ë„ ìž¥ìˆ˜êµ°", "ì „ë¶íŠ¹ë³„ìžì¹˜ë„ ìž„ì‹¤êµ°", "ì „ë¶íŠ¹ë³„ìžì¹˜ë„ ìˆœì°½êµ°", "ì „ë¶íŠ¹ë³„ìžì¹˜ë„ ê³ ì°½êµ°", "ì „ë¶íŠ¹ë³„ìžì¹˜ë„ ë¶€ì•ˆêµ°",
    "ì „ë¼ë‚¨ë„ ëª©í¬ì‹œ", "ì „ë¼ë‚¨ë„ ì—¬ìˆ˜ì‹œ", "ì „ë¼ë‚¨ë„ ìˆœì²œì‹œ", "ì „ë¼ë‚¨ë„ ë‚˜ì£¼ì‹œ", "ì „ë¼ë‚¨ë„ ê´‘ì–‘ì‹œ", "ì „ë¼ë‚¨ë„ ë‹´ì–‘êµ°", "ì „ë¼ë‚¨ë„ ê³¡ì„±êµ°", "ì „ë¼ë‚¨ë„ êµ¬ë¡€êµ°", "ì „ë¼ë‚¨ë„ ê³ í¥êµ°", "ì „ë¼ë‚¨ë„ ë³´ì„±êµ°", "ì „ë¼ë‚¨ë„ í™”ìˆœêµ°", "ì „ë¼ë‚¨ë„ ìž¥í¥êµ°", "ì „ë¼ë‚¨ë„ ê°•ì§„êµ°", "ì „ë¼ë‚¨ë„ í•´ë‚¨êµ°", "ì „ë¼ë‚¨ë„ ì˜ì•”êµ°", "ì „ë¼ë‚¨ë„ ë¬´ì•ˆêµ°", "ì „ë¼ë‚¨ë„ í•¨í‰êµ°", "ì „ë¼ë‚¨ë„ ì˜ê´‘êµ°", "ì „ë¼ë‚¨ë„ ìž¥ì„±êµ°", "ì „ë¼ë‚¨ë„ ì™„ë„êµ°", "ì „ë¼ë‚¨ë„ ì§„ë„êµ°", "ì „ë¼ë‚¨ë„ ì‹ ì•ˆêµ°",
    "ê²½ìƒë¶ë„ í¬í•­ì‹œ", "ê²½ìƒë¶ë„ ê²½ì£¼ì‹œ", "ê²½ìƒë¶ë„ ê¹€ì²œì‹œ", "ê²½ìƒë¶ë„ ì•ˆë™ì‹œ", "ê²½ìƒë¶ë„ êµ¬ë¯¸ì‹œ", "ê²½ìƒë¶ë„ ì˜ì£¼ì‹œ", "ê²½ìƒë¶ë„ ìƒì£¼ì‹œ", "ê²½ìƒë¶ë„ ë¬¸ê²½ì‹œ", "ê²½ìƒë¶ë„ ê²½ì‚°ì‹œ", "ê²½ìƒë¶ë„ ì˜ì„±êµ°", "ê²½ìƒë¶ë„ ì²­ì†¡êµ°", "ê²½ìƒë¶ë„ ì˜ì–‘êµ°", "ê²½ìƒë¶ë„ ì˜ë•êµ°", "ê²½ìƒë¶ë„ ì²­ë„êµ°", "ê²½ìƒë¶ë„ ê³ ë ¹êµ°", "ê²½ìƒë¶ë„ ì„±ì£¼êµ°", "ê²½ìƒë¶ë„ ì¹ ê³¡êµ°", "ê²½ìƒë¶ë„ ì˜ˆì²œêµ°", "ê²½ìƒë¶ë„ ë´‰í™”êµ°", "ê²½ìƒë¶ë„ ìš¸ì§„êµ°", "ê²½ìƒë¶ë„ ìš¸ë¦‰êµ°",
    "ê²½ìƒë‚¨ë„ ì°½ì›ì‹œ", "ê²½ìƒë‚¨ë„ ì§„ì£¼ì‹œ", "ê²½ìƒë‚¨ë„ í†µì˜ì‹œ", "ê²½ìƒë‚¨ë„ ì‚¬ì²œì‹œ", "ê²½ìƒë‚¨ë„ ê¹€í•´ì‹œ", "ê²½ìƒë‚¨ë„ ë°€ì–‘ì‹œ", "ê²½ìƒë‚¨ë„ ê±°ì œì‹œ", "ê²½ìƒë‚¨ë„ ì–‘ì‚°ì‹œ", "ê²½ìƒë‚¨ë„ ì˜ë ¹êµ°", "ê²½ìƒë‚¨ë„ í•¨ì•ˆêµ°", "ê²½ìƒë‚¨ë„ ì°½ë…•êµ°", "ê²½ìƒë‚¨ë„ ê³ ì„±êµ°", "ê²½ìƒë‚¨ë„ ë‚¨í•´êµ°", "ê²½ìƒë‚¨ë„ í•˜ë™êµ°", "ê²½ìƒë‚¨ë„ ì‚°ì²­êµ°", "ê²½ìƒë‚¨ë„ í•¨ì–‘êµ°", "ê²½ìƒë‚¨ë„ ê±°ì°½êµ°", "ê²½ìƒë‚¨ë„ í•©ì²œêµ°",
    "ì œì£¼íŠ¹ë³„ìžì¹˜ë„", "ì œì£¼íŠ¹ë³„ìžì¹˜ë„ ì œì£¼ì‹œ", "ì œì£¼íŠ¹ë³„ìžì¹˜ë„ ì„œê·€í¬ì‹œ"
]

METRO_LIST = ["ì „êµ­", "ì„œìš¸íŠ¹ë³„ì‹œ", "ë¶€ì‚°ê´‘ì—­ì‹œ", "ëŒ€êµ¬ê´‘ì—­ì‹œ", "ì¸ì²œê´‘ì—­ì‹œ", "ê´‘ì£¼ê´‘ì—­ì‹œ", "ëŒ€ì „ê´‘ì—­ì‹œ", "ìš¸ì‚°ê´‘ì—­ì‹œ", "ì„¸ì¢…íŠ¹ë³„ìžì¹˜ì‹œ", "ê²½ê¸°ë„", "ê°•ì›íŠ¹ë³„ìžì¹˜ë„", "ì¶©ì²­ë¶ë„", "ì¶©ì²­ë‚¨ë„", "ì „ë¶íŠ¹ë³„ìžì¹˜ë„", "ì „ë¼ë‚¨ë„", "ê²½ìƒë¶ë„", "ê²½ìƒë‚¨ë„", "ì œì£¼íŠ¹ë³„ìžì¹˜ë„"]

def get_data_from_gsheet():
    auth_json = os.environ.get('GOOGLE_AUTH_JSON')
    if auth_json is None:
        st.error("âŒ 'GOOGLE_AUTH_JSON' í™˜ê²½ ë³€ìˆ˜ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.")
        return pd.DataFrame()
    try:
        creds_dict = json.loads(auth_json)
        scope = ["https://spreadsheets.google.com/feeds", "https://www.googleapis.com/auth/drive"]
        creds = ServiceAccountCredentials.from_json_keyfile_dict(creds_dict, scope)
        client = gspread.authorize(creds)
        sh = client.open("ë‚˜ë¼ìž¥í„°_ìš©ì—­ê³„ì•½ë‚´ì—­")
        ws = sh.get_worksheet(0)
        return pd.DataFrame(ws.get_all_records())
    except Exception as e:
        st.error(f"âŒ ì‹œíŠ¸ ë¡œë“œ ì¤‘ ì˜¤ë¥˜: {e}")
        return pd.DataFrame()

def parse_date(date_val):
    if not date_val: return None
    clean_val = re.sub(r'[^0-9]', '', str(date_val))
    if len(clean_val) >= 8:
        try: return datetime.strptime(clean_val[:8], "%Y%m%d")
        except: return None
    return None

def calculate_logic(row):
    try:
        cntrct_date = parse_date(row.get('ê³„ì•½ì¼ìž'))
        start_date = parse_date(row.get('ì°©ìˆ˜ì¼ìž'))
        period_raw = str(row.get('ê³„ì•½ê¸°ê°„', ''))
        this_match = re.search(r'ê¸ˆì°¨\s*[:\s]*(\d+)', period_raw)
        total_match = re.search(r'ì´ì°¨\s*[:\s]*(\d+)', period_raw) or re.search(r'ì´ìš©ì—­\s*[:\s]*(\d+)', period_raw)
        this_days = int(this_match.group(1)) if this_match else 0
        total_days = int(total_match.group(1)) if total_match else 0
        if not this_days and len(re.sub(r'[^0-9]', '', period_raw)) >= 8:
            final_expire_dt = parse_date(period_raw)
        else:
            base_date = cntrct_date if (this_days == total_days and this_days > 0) else start_date
            if base_date and total_days > 0:
                final_expire_dt = base_date + relativedelta(days=total_days)
            else: return "ì •ë³´ë¶€ì¡±", "ì •ë³´ë¶€ì¡±"
        today = datetime.now()
        expire_str = final_expire_dt.strftime('%Y-%m-%d')
        if final_expire_dt < today: remain_str = "ë§Œë£Œë¨"
        else:
            diff = relativedelta(final_expire_dt, today)
            months = diff.years * 12 + diff.months
            remain_str = f"{months}ê°œì›” {diff.days}ì¼"
        return expire_str, remain_str
    except: return "ê³„ì‚°ë¶ˆê°€", "ì˜¤ë¥˜"

st.set_page_config(layout="wide")
st.title("ðŸ›ï¸ ì „êµ­ ì§€ìžì²´ë³„ ìœ ì§€ë³´ìˆ˜ ê³„ì•½ í˜„í™©")

try:
    df = get_data_from_gsheet()
    if not df.empty:
        # 1. ê¸°ê´€ëª… ë° ê¸°ë³¸ í‚¤ì›Œë“œ í•„í„°ë§
        def filter_agency(agency_name):
            agency_name = str(agency_name).strip()
            return any(agency_name.startswith(dist) for dist in FULL_DISTRICT_LIST)

        df = df[df['â˜…ê°€ê³µ_ìˆ˜ìš”ê¸°ê´€'].apply(filter_agency)]
        df = df[df['â˜…ê°€ê³µ_ê³„ì•½ëª…'].str.contains("ìœ ì§€", na=False)]
        df = df[df['â˜…ê°€ê³µ_ê³„ì•½ëª…'].str.contains("í†µí•©ê´€ì œ", na=False)]

        # 2. ê³„ì•½ ê¸°ê°„ ë° ë§Œë£Œ ì—¬ë¶€ ê³„ì‚°
        df[['â˜…ê°€ê³µ_ê³„ì•½ë§Œë£Œì¼', 'ë‚¨ì€ê¸°ê°„']] = df.apply(lambda r: pd.Series(calculate_logic(r)), axis=1)
        
        # [ì‹ ê·œ ì¶”ê°€] ë§Œë£Œëœ ë°ì´í„° ì‚­ì œ
        df = df[df['ë‚¨ì€ê¸°ê°„'] != "ë§Œë£Œë¨"]

        # 3. ì¤‘ë³µ ì œê±°ë¥¼ ìœ„í•œ í…ìŠ¤íŠ¸ ì •êµí™”
        # [ìˆ˜ì •] ì°¨ìˆ˜(1ì°¨, 2ì°¨ ë“±)ì™€ ì—°ë„ ìˆ«ìžë¥¼ ëª¨ë‘ ì œê±°í•˜ì—¬ ë™ì¼ ì‚¬ì—…êµ°ìœ¼ë¡œ ë¬¶ìŒ
        def clean_contract_name_advanced(name):
            if pd.isna(name): return ""
            name = str(name).replace(" ", "")
            # ì°¨ìˆ˜ êµ¬ë¶„ ì œê±° (1ì°¨, 2ì°¨, 1ì°¨ë¶„, 2ì°¨ë¶„ ë“±)
            name = re.sub(r'\d+ì°¨ë¶„?', '', name)
            # ì—°ë„ ìˆ«ìž ì œê±°
            name = re.sub(r'\d+', '', name)
            return name

        df['contract_group_key'] = df['â˜…ê°€ê³µ_ê³„ì•½ëª…'].apply(clean_contract_name_advanced)
        df['temp_date'] = pd.to_datetime(df['ê³„ì•½ì¼ìž'], errors='coerce')

        # ì •ë ¬: ê¸°ê´€ëª…, ê·¸ë£¹í‚¤, ì—…ì²´ëª…, ë‚ ì§œ(ìµœì‹ ìˆœ)
        df = df.sort_values(by=['â˜…ê°€ê³µ_ìˆ˜ìš”ê¸°ê´€', 'contract_group_key', 'â˜…ê°€ê³µ_ì—…ì²´ëª…', 'temp_date'], 
                           ascending=[True, True, True, False])

        # [ì‹ ê·œ ì¶”ê°€] ë™ì¼ ì‚¬ì—…êµ° ë‚´ì—ì„œ ìµœì¢… ì°¨ìˆ˜(ê°€ìž¥ ìµœì‹  ë‚ ì§œ)ë§Œ ìœ ì§€
        df = df.drop_duplicates(subset=['â˜…ê°€ê³µ_ìˆ˜ìš”ê¸°ê´€', 'contract_group_key', 'â˜…ê°€ê³µ_ì—…ì²´ëª…'], keep='first')

        # 4. í›„ì²˜ë¦¬
        df['â˜…ê°€ê³µ_ê³„ì•½ê¸ˆì•¡'] = pd.to_numeric(df['â˜…ê°€ê³µ_ê³„ì•½ê¸ˆì•¡'], errors='coerce').fillna(0).astype(int)
        
        def get_metro_name(agency):
            agency = str(agency)
            for metro in METRO_LIST[1:]:
                if agency.startswith(metro): return metro
            return "ê¸°íƒ€"
        
        df['ê´‘ì—­ë‹¨ìœ„'] = df['â˜…ê°€ê³µ_ìˆ˜ìš”ê¸°ê´€'].apply(get_metro_name)

        # --- ìƒë‹¨ í•„í„° UI ---
        st.subheader("ðŸ“ ì§€ì—­ë³„ í•„í„° ì„ íƒ")
        selected_region = st.radio("ê´‘ì—­ì‹œë„ë¥¼ ì„ íƒí•˜ì„¸ìš”:", METRO_LIST, horizontal=True)

        filtered_df = df.copy() if selected_region == "ì „êµ­" else df[df['ê´‘ì—­ë‹¨ìœ„'] == selected_region].copy()

        st.divider()
        st.write(f"### ðŸ“Š {selected_region} ë¶„ì„ í˜„í™© (ì´ {len(filtered_df)}ê±´)")
        
        display_cols = ['â˜…ê°€ê³µ_ìˆ˜ìš”ê¸°ê´€', 'â˜…ê°€ê³µ_ê³„ì•½ëª…', 'â˜…ê°€ê³µ_ì—…ì²´ëª…', 'â˜…ê°€ê³µ_ê³„ì•½ê¸ˆì•¡', 'ê³„ì•½ì¼ìž', 'ì°©ìˆ˜ì¼ìž', 'â˜…ê°€ê³µ_ê³„ì•½ë§Œë£Œì¼', 'ë‚¨ì€ê¸°ê°„', 'ê³„ì•½ìƒì„¸ì •ë³´URL']
        existing_cols = [c for c in display_cols if c in filtered_df.columns]
        final_df = filtered_df[existing_cols].copy()
        final_df.columns = [c.replace('â˜…ê°€ê³µ_', '') for c in final_df.columns]
        final_df.columns = [c.replace('ê³„ì•½ìƒì„¸ì •ë³´URL', 'URL') for c in final_df.columns]

        # CSV ë‹¤ìš´ë¡œë“œ
        csv_data = final_df.to_csv(index=False, encoding='utf-8-sig').encode('utf-8-sig')
        col1, col2 = st.columns([0.8, 0.2])
        with col2:
            st.download_button(
                label=f"ðŸ“¥ {selected_region} ë°ì´í„° ë‹¤ìš´ë¡œë“œ",
                data=csv_data,
                file_name=f"ê³„ì•½í˜„í™©_{selected_region}_{datetime.now().strftime('%Y%m%d')}.csv",
                mime="text/csv"
            )

        st.dataframe(
            final_df,
            column_config={
                "URL": st.column_config.LinkColumn("ìƒì„¸ì •ë³´"),
                "ê³„ì•½ê¸ˆì•¡": st.column_config.NumberColumn("ê³„ì•½ê¸ˆì•¡(ì›)", format="localized"),
            },
            use_container_width=True,
            hide_index=True,
            height=800
        )
    else:
        st.warning("í‘œì¶œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.")
except Exception as e:
    st.error(f"ì˜¤ë¥˜ ë°œìƒ: {e}")
