name: Daily Procurement Data Bot

on:
  schedule:
    # í•œêµ­ ì‹œê°„ ê¸°ì¤€ ë§¤ì¼ 09:30 (UTC 00:30)
    - cron: '30 23 * * *'
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰ ë²„íŠ¼ í™œì„±í™”

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: |
          pip install gspread oauth2client requests pytimekr

      - name: Run script
        env:
          # Secretsì— ì €ì¥í•œ ë³€ìˆ˜ë¥¼ í™˜ê²½ë³€ìˆ˜ë¡œ ì£¼ì…
          DATA_GO_KR_API_KEY: ${{ secrets.DATA_GO_KR_API_KEY }}
          GOOGLE_AUTH_JSON: ${{ secrets.GOOGLE_AUTH_JSON }}
        run: python main.py

      - name: Send MS Teams Notification
        if: always()
        run: |
          # 1. ìƒíƒœì— ë”°ë¥¸ ìƒ‰ìƒ ë° ì•„ì´ì½˜ ì„¤ì •
          if [ "${{ job.status }}" == "success" ]; then
            STATUS_TEXT="âœ… ì„±ê³µ"
            COLOR="good"
          else
            STATUS_TEXT="âŒ ì‹¤íŒ¨"
            COLOR="attention"
          fi

          # 2. íŒ€ì¦ˆ ì›Œí¬í”Œë¡œìš© JSON ë³¸ë¬¸ ìƒì„± (Adaptive Cards 1.4 ê·œê²©)
          # ìµœì‹  ì›Œí¬í”Œë¡œëŠ” ì´ ê·œê²©ìœ¼ë¡œ ë³´ë‚´ì•¼ ì¸ì¦ ì—ëŸ¬ê°€ ë‚˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
          cat <<EOF > teams_payload.json
          {
            "type": "message",
            "attachments": [
              {
                "contentType": "application/vnd.microsoft.card.adaptive",
                "content": {
                  "type": "AdaptiveCard",
                  "body": [
                    {
                      "type": "TextBlock",
                      "size": "Medium",
                      "weight": "Bolder",
                      "text": "ğŸ¤– ì¡°ë‹¬ì²­ ë°ì´í„° ìˆ˜ì§‘ ë´‡ ë¦¬í¬íŠ¸"
                    },
                    {
                      "type": "FactSet",
                      "facts": [
                        { "title": "ê²°ê³¼", "value": "$STATUS_TEXT" },
                        { "title": "ì‹¤í–‰ì‹œê°„", "value": "í•œêµ­ ì‹œê°„ 09:30" },
                        { "title": "ë¡œê·¸", "value": "[GitHub Actions í™•ì¸](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" }
                      ]
                    },
                    {
                      "type": "TextBlock",
                      "text": "ë°ì´í„°ê°€ ë¶„ê¸°ë³„ íŒŒì¼ ë‚´ í•´ë‹¹ ì›” íƒ­ì— ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.",
                      "wrap": true
                    }
                  ],
                  "\$schema": "http://adaptivecards.io/schemas/adaptive-card.json",
                  "version": "1.4"
                }
              }
            ]
          }
          EOF

          # 3. Webhook ì „ì†¡
          curl -X POST -H "Content-Type: application/json" -d @teams_payload.json "${{ secrets.TEAMS_WEBHOOK_URL }}"
