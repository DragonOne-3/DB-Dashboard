name: Daily Procurement Data Bot

on:
  schedule:
    # í•œêµ­ ì‹œê°„ ê¸°ì¤€ ë§¤ì¼ 09:30 (UTC 00:30)
    - cron: '30 23 * * *'
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰ ë²„íŠ¼ í™œì„±í™”

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: |
          pip install gspread oauth2client requests pytimekr

      - name: Run script
        env:
          # Secretsì— ì €ì¥í•œ ë³€ìˆ˜ë¥¼ í™˜ê²½ë³€ìˆ˜ë¡œ ì£¼ì…
          DATA_GO_KR_API_KEY: ${{ secrets.DATA_GO_KR_API_KEY }}
          GOOGLE_AUTH_JSON: ${{ secrets.GOOGLE_AUTH_JSON }}
        run: python main.py

      - name: Send MS Teams Notification
        if: always()
        env:
          TEAMS_WEBHOOK_URL: ${{ secrets.TEAMS_WEBHOOK_URL }}
        run: |
          # íŒŒì´ì¬ í•œ ì¤„ ì½”ë“œë¡œ ì•ˆì „í•˜ê²Œ ì „ì†¡ (URL ê¼¬ì„ ë°©ì§€)
          python - <<EOF
          import os, requests, json
          status = "${{ job.status }}"
          status_text = "âœ… ì„±ê³µ" if status == "success" else "âŒ ì‹¤íŒ¨"
          color = "good" if status == "success" else "attention"
          webhook_url = os.environ.get('TEAMS_WEBHOOK_URL')

          payload = {
              "type": "message",
              "attachments": [{
                  "contentType": "application/vnd.microsoft.card.adaptive",
                  "content": {
                      "type": "AdaptiveCard",
                      "body": [
                          {"type": "TextBlock", "text": "ğŸ¤– ì¡°ë‹¬ì²­ ë°ì´í„° ìˆ˜ì§‘ ë´‡ ë¦¬í¬íŠ¸", "weight": "Bolder", "size": "Medium"},
                          {"type": "FactSet", "facts": [
                              {"title": "ê²°ê³¼", "value": status_text},
                              {"title": "ì‹¤í–‰ì‹œê°„", "value": "í•œêµ­ ì‹œê°„ 09:30"},
                              {"title": "ë¡œê·¸", "value": "[GitHub Actions í™•ì¸](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})"}
                          ]},
                          {"type": "TextBlock", "text": "ë°ì´í„°ê°€ ë¶„ê¸°ë³„ íŒŒì¼ ë‚´ í•´ë‹¹ ì›” íƒ­ì— ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.", "wrap": True}
                      ],
                      "\$schema": "http://adaptivecards.io/schemas/adaptive-card.json",
                      "version": "1.4"
                  }
              }]
          }
          requests.post(webhook_url, json=payload)
          EOF
